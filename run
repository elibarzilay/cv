#!/usr/bin/env bash

cd "$(dirname "$0")"
here="$PWD"

mkdir -p "build" "download"

printf -v rx "|%s" \
       "Jan" "January" \
       "Feb" "February" \
       "Mar" "March" \
       "Apr" "April" \
       "May" \
       "Jun" "June" \
       "Jul" "July" \
       "Aug" "August" \
       "Sep" "September" \
       "Oct" "October" \
       "Nov" "November" \
       "Dec" "December" \
       "Mid" "Fall" "Spring"

rx="(((${rx:1}) )?(19[89]|2[0-2][0-2])[0-9]|Present)"
rx="$rx( ?[-–—]+ ?$rx)?"
extract_dates() {
  grep -woE "$rx" "$1"
}

md_to_text() {
  I="$1" O="$2" node -e '
    fs.writeFileSync(process.env.O,
      fs.readFileSync(process.env.I).toString()
        .replaceAll(/(?<=^|\n\n)(#+) +(.*)(?=\n)/g, (_, h, s) =>
          s+"\n"+(h.length <= 2 ? "=" : "-").repeat(s.length))
        .replaceAll(/ +\\\n/g, "\n")
        .replaceAll(/<(https?:\/\/[^<>]+|[^<>@]+@[^<>@]+)>/g, "$1")
        .replaceAll(/\*("[^"]+")\*/g, "$1"));
  '
}

run_check() { # output cmd ...
  local out="$1"; shift
  "$@" > "$out.new" || exit 1
  if [[ ! -e "$out" ]]; then
    echo "Created $out"
    mv "$out.new" "$out"
  elif ! diff "$out" "$out.new"; then
    echo ""
    echo "Changes in $out.new"
    echo "* Remove \"$out\" or manually update from \"$out.new\""
    echo "* Re-run"
    exit 1
  else
    rm "$out.new"
  fi
}

for what in "long" "short"; do
  echo "$what..."
  out="download/Eli_Barzilay-$what"
  ####
  md="build/$what.md"
  run_check "build/$what.md" ./cv.rkt "$what" "md"
  if grep -qE ".{80}" "$md"; then
    echo "Error: got lines over 80 chars in $md" 1>&2; exit 1
  fi
  ####
  run_check "build/dates-$what" extract_dates "$md"
  ####
  tex="build/$what.tex"
  run_check "$tex" ./cv.rkt "$what" "tex"
  ln -sf "../acv/awesome-cv.cls" "../acv/fonts" "build"
  args=(--halt-on-error --interaction="nonstopmode")
  args+=("../$tex")
  # twice to get a TOC, show nothing on first run, warnings on the second run
  (cd "build"; xelatex "${args[@]}") > "/tmp/xelatex-log" \
    || { cat "/tmp/xelatex-log"; exit 1; }
  (cd "build"; xelatex "${args[@]}") \
    | awk 'BEGIN{IGNORECASE=1} /warning|!/{show=1} /^$/{show=0} show;' \
    | { grep -v 'Package floatflt Warning: Floating figures .* colliding' \
          || test $? = 1; } \
    || exit 1
  rm -f "build/$what."{"aux","out","log"}
  rm -f "build/"{"texput.log","awesome-cv.cls","fonts"}
  mv "build/$what.pdf" "$out.pdf"
  ####
  args=(-s)
  # args+=(-M author="Eli Barzilay")
  args+=(-M title="Eli Barzilay: Curriculum Vitae")
  # args+=(-M date="2021-12-31")
  args+=(-M papersize="letter")
  args+=(--resource-path="$here/acv/fonts")
  # args+=(-M fontfamily="FiraSans")
  # args+=(-M fontfamilyoptions="default")
  # args+=(-V "mainfont:FiraSans")
  # args+=(-V "sansfont:FiraSans")
  # args+=(-V "monofont:Consolas")
  if [[ -e "$out.docx" ]]; then cp "$out.docx" "build/ref.docx"; fi
  args+=(--reference-doc="build/ref.docx")
  # pandoc -f commonmark "$md""${args[@]}" -o "$tex"
  args+=(--pdf-engine="xelatex")
  pandoc -f commonmark "$md" "${args[@]}" -o "$out.docx" || exit 1
  # pandoc -f latex "$tex" "${args[@]}" -o "$out.docx" || exit 1
  rm -f "build/ref.docx"
  ####
  md_to_text "$md" "$out.txt" || exit 1
done

echo "done"
